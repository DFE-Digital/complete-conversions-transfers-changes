name: Run Cypress tests

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
    secrets:
      CYPRESS_URL_ENDPOINT:
        required: true
      CYPRESS_API_ENDPOINT:
        required: true
      CYPRESS_USERNAME:
        required: true
      CYPRESS_AUTH_KEY:
        required: true
      CYPRESS_TENANT_ID:
        required: true
      CYPRESS_CLIENT_ID:
        required: true
      CYPRESS_CLIENT_SECRET:
        required: true
      CYPRESS_COMPLETEAPI_CLIENTID:
        required: true
      TEAMS_WEBHOOK_URL:
        required: true

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests against'
        required: true
        type: environment

concurrency:
  group: ${{ github.workflow }}

jobs:
  cypress-tests:
    name: Run Cypress Tests
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - group: conversion-tasks
            browser: "edge"
            spec: |
              cypress/e2e/conversion-tasks/**/*.cy.ts
          - group: conversions
            browser: "edge"
            spec: |
              cypress/e2e/conversions/**/*.cy.ts
          - group: project-listings
            browser: "edge"
            spec: |
              cypress/e2e/project-listings/**/*.cy.ts
          - group: transfer-tasks
            browser: "edge"
            spec: |
              cypress/e2e/transfer-tasks/**/*.cy.ts
          - group: transfers
            browser: "edge"
            spec: |
              cypress/e2e/transfers/**/*.cy.ts
          - group: user-capabilities-regional-workers
            browser: "edge"
            spec: |
              cypress/e2e/user-capabilities-regional-workers/**/*.cy.ts
          - group: user-capabilities-support
            browser: "edge"
            spec: |
              cypress/e2e/user-capabilities-support/**/*.cy.ts
    container:
      image: cypress/browsers:22.15.1@sha256:753c6dd8dc176c2eb9e9a622146d2c260e308e86eb62ce2b3e6f12e7d67d7b13
    defaults:
      run:
        working-directory: src/Tests/Dfe.Complete.CypressTests
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          ref: ${{ github.ref }}

      - name: Run
        uses: cypress-io/github-action@v6
        env:
          CYPRESS_url: ${{ secrets.CYPRESS_URL_ENDPOINT }}
          CYPRESS_api: ${{ secrets.CYPRESS_API_ENDPOINT }}
          CYPRESS_username: ${{ secrets.CYPRESS_USERNAME }}
          CYPRESS_authKey: ${{ secrets.CYPRESS_AUTH_KEY }}
          CYPRESS_tenantId: ${{ secrets.CYPRESS_TENANT_ID }}
          CYPRESS_clientId: ${{ secrets.CYPRESS_CLIENT_ID }}
          CYPRESS_clientSecret: ${{ secrets.CYPRESS_CLIENT_SECRET }}
          CYPRESS_completeApiClientId: ${{ secrets.CYPRESS_COMPLETEAPI_CLIENTID }}
        with:
          browser: ${{ matrix.browser }}
          spec: ${{ matrix.spec }}
          working-directory: ./src/Tests/Dfe.Complete.CypressTests

      - name: Upload screenshots
        if: ${{ failure() }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: screenshots-${{ inputs.environment }}-${{ matrix.group }}
          path: src/Tests/Dfe.Complete.CypressTests/cypress/screenshots

      - name: Rename raw test results
        if: always()
        run: |
          mkdir -p cypress/reports/merged
          for file in cypress/reports/mocha/*.json; do
            filename=$(basename "$file")
            cp "$file" "cypress/reports/merged/${{ matrix.group }}-$filename"
          done

      - name: Upload raw test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: raw-test-reports
          path: src/Tests/Dfe.Complete.CypressTests/cypress/reports/merged/*.json
  generate-combined-report:
    name: Generate Combined Report
    needs: cypress-tests
    runs-on: ubuntu-latest
    if: always()
    defaults:
      run:
        working-directory: src/Tests/Dfe.Complete.CypressTests
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          name: raw-test-reports
          path: src/Tests/Dfe.Complete.CypressTests/cypress/reports/mocha

      - name: List downloaded files
        run: find cypress/reports/mocha -type f -name "*.json" | sort

      - name: Generate combined HTML report
        run: |
          mkdir -p mochareports
          npm run generate:html:report

      - name: Upload combined report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: combined-report-${{ inputs.environment }}
          path: src/Tests/Dfe.Complete.CypressTests/mochareports

      - name: Report results to Teams
        if: always()
        run: |
          node <<EOF
          const axios = require('axios');
          const fs = require('fs');
          const path = require('path');
          
          // Read the combined report JSON to get test statistics
          let reportStats = { tests: 0, passes: 0, failures: 0 };
          try {
            const reportPath = path.join(process.cwd(), 'mochareports', 'report.json');
            if (fs.existsSync(reportPath)) {
              const reportData = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              if (reportData && reportData.stats) {
                reportStats = {
                  tests: reportData.stats.tests || 0,
                  passes: reportData.stats.passes || 0,
                  failures: reportData.stats.failures || 0
                };
              }
            }
          } catch (error) {
            console.error('Error reading report file:', error);
          }
          
          const webhookUrl = process.env.TEAMS_WEBHOOK_URL;
          const message = {
            type: "message",
            attachments: [
              {
                contentType: "application/vnd.microsoft.card.adaptive",
                contentUrl: null,
                content: {
                  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  type: "AdaptiveCard",
                  version: "1.2",
                  body: [
                    {
                      type: "Container",
                      style: process.env.GITHUB_JOB_STATUS == 'success' ? "good" : "attention",
                      items: [
                        {
                          type: "TextBlock",
                          wrap: true,
                          text: process.env.GITHUB_JOB_STATUS == 'success' ? "**Cypress Test Run Passed** ✅" : "**Cypress Test Run Failed** ❌",
                          size: "large",
                          horizontalAlignment: "center"
                        },
                        {
                          type: "TextBlock",
                          wrap: true,
                          text: "**Branch:** " + process.env.GITHUB_REF
                        },
                        {
                          type: "TextBlock",
                          wrap: true,
                          text: "**Workflow:** " + process.env.GITHUB_WORKFLOW
                        },
                        {
                          type: "TextBlock",
                          wrap: true,
                          text: "**Environment:** " + process.env.ENVIRONMENT
                        },
                        {
                          type: "FactSet",
                          facts: [
                            {
                              title: "Total Tests:",
                              value: reportStats.tests.toString()
                            },
                            {
                              title: "Passed:",
                              value: reportStats.passes.toString()
                            },
                            {
                              title: "Failed:",
                              value: reportStats.failures.toString()
                            }
                          ]
                        },
                        {
                          type: "TextBlock",
                          wrap: true,
                          text: "**See more information:** [" + process.env.INFORMATION_LINK + "](" + process.env.INFORMATION_LINK + ")"
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          }
          axios.post(webhookUrl, message)
            .then(() => console.log("Message sent to Teams"))
            .catch(err => { console.error("Error sending to Teams", err); process.exit(1); });
          EOF
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          ENVIRONMENT: ${{ inputs.environment }}
          INFORMATION_LINK: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          GITHUB_JOB_STATUS: ${{ job.status }}
