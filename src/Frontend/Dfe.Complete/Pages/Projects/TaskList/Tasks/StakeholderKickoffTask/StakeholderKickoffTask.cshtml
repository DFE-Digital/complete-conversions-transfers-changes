@page "/projects/{projectId}/tasks/stakeholder_kick_off"
@using Dfe.Complete.Constants
@using Dfe.Complete.Domain.Enums
@inject Microsoft.Extensions.Configuration.IConfiguration _configuration
@model Dfe.Complete.Pages.Projects.TaskList.Tasks.StakeholderKickoffTask.StakeholderKickoffTaskModel
@inject Dfe.Complete.Services.ErrorService ErrorService
@{

    Layout = "_ProjectTaskLayout";
    ViewData["Title"] = "External stakeholder kick-off";

    var backlink = string.Format(RouteConstants.ProjectTaskList, Model.ProjectId);
    const string significantDateField = nameof(Model.SignificantDate);

    var isConversion = Model.Project.Type == ProjectType.Conversion;
    var projectTypeString = isConversion ? "conversion" : "transfer";
    var trustInfoString = isConversion ? "school or trust," : "outgoing trust, the incoming trust";
}
@section TaskHeaderHintSection  {
    <div class="govuk-hint"> 
        <p>
            This is where you make sure everyone involved in the @projectTypeString knows what they need to do, and when to do it, so the @(isConversion ? "school can become an academy" : "academy can transfer") on time.
        </p> 
        <p>
            This is also a good opportunity to talk about common problems and how to avoid them.
        </p>
    </div>
}

@section TaskSection 
{
    <form method="post">
        <govuk-checkboxes name="options">
            <govuk-checkboxes-fieldset>
                <govuk-checkboxes-fieldset-legend is-page-heading="true" class="govuk-fieldset__legend--l"> 
                </govuk-checkboxes-fieldset-legend>

                <govuk-checkboxes-item data-cy="stakeholder_kick_off_task_form_introductory_emails" id="stakeholder_kick_off_task_form_introductory_emails" asp-for="@Model.SendIntroEmails" value="true" name="send-intro-emails" checked="@Model.SendIntroEmails">
                    <b> Send introductory emails</b>
                    <govuk-checkboxes-item-hint>
                        <p>
                            Email the @trustInfoString and their solicitors. Email the diocese too if this is a faith @(isConversion ? "school" : "academy").
                        </p>
                        <govuk-details>
                            <govuk-details-summary>
                                <span class="govuk-details__summary-text">What to include in introductory emails</span>
                            </govuk-details-summary>
                            <govuk-details-text>
                                <p>You can <external-link href="@_configuration["ExternalLinks:EmailTemplate"]">choose an email template (opens in new tab)</external-link> to help you write your introductory emails. There are templates for the @(isConversion ? "school or trust," : "outgoing trust, incoming trust") and their solicitors.</p>
                                <p>This will help you to:</p>
                                <ul>
                                    <li>organise kick-off meetings</li>
                                    <li>clarify roles and expectation</li>
                                    <li>establish dates and deadlines</li>
                                    <li>provide links to documents that need to be completed</li>
                                    <li>agree ways of working</li>
                                </ul>
                                <p>You should aim to do this in the first week after you have been assigned the project.</p>
                                <p>Ideally the kick-off meeting should take place within the first two weeks.</p>
                            </govuk-details-text>
                        </govuk-details>  
                    </govuk-checkboxes-item-hint>
                </govuk-checkboxes-item>

                @if (isConversion)
                {
                    <govuk-checkboxes-item data-cy="stakeholder_kick_off_task_form_local_authority_proforma" id="stakeholder_kick_off_task_form_local_authority_proforma" asp-for="@Model.LocalAuthorityProforma" value="true" name="local-authority-proforma" checked="@Model.LocalAuthorityProforma">
                        <b>Check the local authority proforma</b>
                        <govuk-checkboxes-item-hint>
                            <p>Check the information is correct and there is no missing information. </p>
                            <govuk-details>
                                <govuk-details-summary>
                                    <span class="govuk-details__summary-text">What to do if you don't have the local authority proforma</span>
                                </govuk-details-summary>
                                <govuk-details-text>
                                    <p>The person who prepared this project for advisory board should have asked for the proforma from the local authority and saved it in SharePoint.</p>
                                    <p>However, some local authorities will not share the proforma until after the academy order has been issued.</p>
                                    <p>If it is not in SharePoint, check if the person who prepared the project has asked for it.</p>
                                    <p>If they have not, ask the local authority to send the proforma to you and save it in SharePoint.</p>
                                    <p>You can <a class="govuk-link" href="@_configuration["ExternalLinks:LocalAuthorityEmailTemplate"]" target="blank">use a local authority email template (opens in new tab)</a> to help you write this email.</p>
                                </govuk-details-text>
                            </govuk-details> 
                        </govuk-checkboxes-item-hint>
                    </govuk-checkboxes-item>

                    <govuk-checkboxes-item data-cy="stakeholder_kick_off_task_form_Local_authority_able_to_convert" id="stakeholder_kick_off_task_form_Local_authority_able_to_convert" asp-for="@Model.LocalAuthorityAbleToConvert" value="true" name="local-authority-able-to-convert" checked="@Model.LocalAuthorityAbleToConvert">
                        <b>Check the local authority is able to convert the school by the provisional conversion date: @Model.Project.SignificantDate.ToDateString()</b>
                        <govuk-checkboxes-item-hint>
                            <p>
                                The school or trust may have provided a provisional conversion date. Email the local authority to make sure they are able to do what they need to do by this date.
                            </p>
                            <govuk-details>
                                <govuk-details-summary>
                                    <span class="govuk-details__summary-text">What to do if the local authority is not able to meet the provisional conversion date</span>
                                </govuk-details-summary>
                                <govuk-details-text>
                                    <p>Tell the school and trust if the local authority cannot complete the conversion by the provisional date.</p>
                                    <p>If this happens you'll need to work with the school, trust and local authority to agree a new date.</p>
                                </govuk-details-text>
                            </govuk-details>
                        </govuk-checkboxes-item-hint>
                    </govuk-checkboxes-item>

                }

                <govuk-checkboxes-item data-cy="stakeholder_kick_off_task_form_setup_meeting" id="stakeholder_kick_off_task_form_setup_meeting" asp-for="@Model.SendInvites" value="true" name="send-invites" checked="@Model.SendInvites">
                    <b>Send invites to the kick-off meeting or call</b>
                    <govuk-checkboxes-item-hint>
                        <p>Check who the @(isConversion? "school or":"outgoing and incoming") trust would like to attend the kick-off meeting.</p>
                        <govuk-details>
                            <govuk-details-summary>
                                <span class="govuk-details__summary-text">How to arrange the kick-off meeting</span>
                            </govuk-details-summary>
                            <govuk-details-text>
                                <p>You should have included possible dates for the kick-off meeting in your introductory email.</p>
                                <p>Once the @(isConversion?"school":"trust") have got back to you with a suitable date and list of attendees, send out invites to arrange the time, date and location of the meeting. It's likely to be a video call over Microsoft Teams.</p>
                                <p>Some @(isConversion ? "schools and " : "")trusts may prefer to have a one-to-one call with you, rather than a meeting involving all stakeholders.</p>
                            </govuk-details-text>
                        </govuk-details> 
                    </govuk-checkboxes-item-hint>
                </govuk-checkboxes-item>

                <govuk-checkboxes-item data-cy="stakeholder_kick_off_task_form_meeting" id="stakeholder_kick_off_task_form_meeting" asp-for="@Model.HostMeetingOrCall" value="true" name="host-meeting-or-call" checked="@Model.HostMeetingOrCall">
                    <b>Host the kick-off meeting or call</b>
                    <govuk-checkboxes-item-hint>
                        <p>Make sure all attendees understand what they need to do, and when they need to do it.</p>
                        @if(isConversion)
                        {
                            <govuk-details>
                                <govuk-details-summary>
                                    <span class="govuk-details__summary-text">What to talk about in the meeting</span>
                                </govuk-details-summary>
                                <govuk-details-text>
                                    <p>You should discuss and record issues that might complicate or delay the project.</p>
                                    <p>You can <external-link href="@_configuration["ExternalLinks:ConversionChecklist"]">use the @projectTypeString checklist (opens in new tab)</external-link> to guide the conversation and make sure you talk about everything you need to.</p>
                                </govuk-details-text>
                            </govuk-details>
                        }
                        else
                        {
                            <p>You should discuss and record issues that might complicate or delay the project.</p>
                        }
               
            </govuk-checkboxes-item-hint>
            </govuk-checkboxes-item>

        </govuk-checkboxes-fieldset>
        </govuk-checkboxes>

        @if (!Model.Project.SignificantDateProvisional is false)
        {
            <govuk-date-input data-cy="SignificantDate" id="SignificantDate" name-prefix="significant-date" asp-for="@Model.SignificantDate">
            <govuk-date-input-fieldset>
                <govuk-date-input-fieldset-legend class="govuk-fieldset__legend--m">
                    Enter the confirmed @projectTypeString date
                </govuk-date-input-fieldset-legend>
                <govuk-date-input-hint>
                    <p>Everyone should have agreed to and know the confirmed @projectTypeString date.</p>
                        <p>You only need to enter a month and year. All @(isConversion ? "schools convert" : "academies transfer") on the first day of the month.</p>
                    @if (ErrorService.HasErrorForKey(significantDateField))
                    {
                        <govuk-date-input-error-message>@(ErrorService.GetErrorMessage(significantDateField))</govuk-date-input-error-message>
                    }
                </govuk-date-input-hint>
            </govuk-date-input-fieldset>
            </govuk-date-input>
        }
        else
        {
            <div class="govuk-inset-text">
                <p>The @projectTypeString date has been confirmed and is currently @Model.Project.SignificantDate.ToDateString()</p>
                <p>The provisional @projectTypeString date was @Model.Project.SignificantDateHistories?.OrderBy(p => p.CreatedAt).First().PreviousDate.ToDateString().</p>
                <p>Any further changes to the @projectTypeString date must be recorded on the main project screen.</p>
            </div>
        }
        @await Html.PartialAsync("_TaskSaveAndReturn", new TaskSaveAndReturnModel(Model.Project, Model.CurrentUserTeam))
    </form> 
}